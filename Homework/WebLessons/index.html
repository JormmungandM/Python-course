<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
   
    <title>Py191</title>
</head>
<body>
    <h1>Py-191</h1>
    <div class="row">
        <div class="input-field col s4">
          <input id ="user-login" type="text" class="validate">
          <label for="user-login">Логин</label>
        </div>
        <div class="input-field col s4">
          <input id ="user-password" type="password" class="validate">
          <label for="user-password">Пароль</label>
        </div>
        <div  class="col s4">
            <input type="button" id="login-button" value="Войти" class="btn"/>
            <!-- Прячим кнопку с помощью типа "hidden" -->
            <input disabled type="button" id="items-button" value="Контент" class="btn"/>
        </div>
    </div>
    <div class="row">
        <p id="out"></p>
    </div>
    

<script>
    document.addEventListener('DOMContentLoaded',()=>{
        const loginButton = document.querySelector( "#login-button" );
        if( ! loginButton ) throw "DOMContentLoaded: #login-button not found";
        loginButton.addEventListener( 'click', loginButtonClick );

        const itemsButton = document.querySelector( "#items-button" );
        if( ! itemsButton ) throw "DOMContentLoaded: #items-button not found";
        itemsButton.addEventListener( 'click', itemsButtonClick );
    });

    function itemsButtonClick(e){
        
        var access_token = window.sessionStorage.getItem( "access_token" ) ;
        alert(access_token)
        document.getElementById("out").value = access_token
        fetch( "/items", {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + access_token
        }
        })
    }

    function loginButtonClick(e){
        
        const userLogin = document.querySelector( "#user-login" );
        if( ! userLogin ) throw "loginButtonClick: #user-login not found";
        const userPassword = document.querySelector( "#user-password" );
        if( ! userLogin ) throw "loginButtonClick: #user-password not found";

        const credentials = btoa( userLogin.value + ':' + userPassword.value ) ;

        fetch( "/auth", {
        method: 'GET',
        headers: {
            'Authorization': 'Basic ' + credentials
        }
        }).then( r => {
            if( r.status != 200 ){
                alert("Логин или пароль неправильные")
            }else{
                r.json().then( j => {
                    console.log( j );
                    // window.sessionStorage.setItem( "access_token", j.access_token ) ;
                    // alert(j.access_token)
                    // При успешной авторизации показываем кнопку контент
                    document.getElementById("items-button").removeAttribute("disabled");
                });
            }
        });
    }
</script>

</body>
</html>